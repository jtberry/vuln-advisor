# VulnAdvisor Caddyfile
#
# {$DOMAIN} reads the DOMAIN environment variable at runtime:
#   DOMAIN=localhost      -> Caddy uses a self-signed cert (tls internal)
#   DOMAIN=example.com   -> Caddy auto-provisions a Let's Encrypt cert
#
# HTTP to HTTPS redirect is automatic and built in to Caddy.
# No extra redirect block is needed.

{$DOMAIN} {
    reverse_proxy app:8000

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        # 'unsafe-inline' in script-src is required for the data island pattern ({{ data | tojson }} in
        # dashboard.html) and the session expiry script in layout.html. Nonce-based CSP would remove
        # this requirement but needs server-side nonce injection on every request -- tracked as tech debt.
        # 'unsafe-inline' in style-src covers the <style> block in layout.html.
        # unpkg.com hosts htmx; cdn.jsdelivr.net hosts Bootstrap and Chart.js.
        Content-Security-Policy "default-src 'self'; script-src 'self' cdn.jsdelivr.net unpkg.com 'unsafe-inline'; style-src 'self' cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data:; font-src 'self' cdn.jsdelivr.net; connect-src 'self'"
    }
}
