{#
  partials/vuln_row.html -- A single <tr> for the vulnerability table.

  Used in two contexts:
    1. Included by asset_detail.html (initial page render)
    2. Returned by the HTMX fragment route (add-CVEs tbody swap) -- vuln_table_body.html

  Required context variables:
    vuln          -- AssetVulnerability dataclass
    enriched      -- EnrichedCVE or None
    deadline_info -- dict with {text, css} from _deadline_info()
    nvd_url       -- NVD detail URL string
    asset_id      -- int
    statuses      -- list of valid status strings (kept for HTMX route compatibility)
#}

{# Badge CSS class map for server-side rendering.
   The closed style is applied via inline style; for other statuses we use Bootstrap classes. #}
{% set _badge_cls = {
  'open':        'bg-secondary',
  'in_review':   'bg-info text-dark',
  'remediated':  'bg-success',
  'deferred':    'bg-warning text-dark',
} %}

<tr id="row-{{ vuln.cve_id }}" data-cve="{{ vuln.cve_id }}">

  {# Checkbox -- first column for bulk selection #}
  <td class="text-center" style="width: 32px; padding-left: 0.75rem">
    <input type="checkbox"
           class="form-check-input vuln-checkbox"
           data-cve-id="{{ vuln.cve_id }}"
           style="cursor: pointer">
  </td>

  {# CVE ID #}
  <td style="padding-left: 0.5rem">
    <a href="/cve/{{ vuln.cve_id }}"
       class="text-decoration-none font-mono fw-semibold"
       style="font-size: 0.85rem; color: #58a6ff">
      {{ vuln.cve_id }}
    </a>
    <a href="{{ nvd_url }}"
       target="_blank"
       rel="noopener noreferrer"
       class="text-muted text-decoration-none"
       style="font-size: 0.68rem; margin-left: 4px"
       title="View on NVD">
      &nearr;
    </a>
    {% if vuln.scanner != 'manual' %}
    <div class="text-muted" style="font-size: 0.68rem">via {{ vuln.scanner }}</div>
    {% endif %}
  </td>

  {# Priority (effective + base if modifier was applied) #}
  <td>
    <span class="badge badge-{{ vuln.effective_priority | lower }}">
      {{ vuln.effective_priority }}
    </span>
    {% if vuln.base_priority and vuln.base_priority != vuln.effective_priority %}
    <span class="badge ms-1"
          style="background-color: #21262d; color: #8b949e; font-size: 0.65rem"
          title="Base priority before criticality modifier">
      {{ vuln.base_priority }}
    </span>
    {% endif %}
  </td>

  {# CVSS score #}
  <td>
    {% if enriched and enriched.cvss.score is not none %}
    <span class="font-mono
      {% if enriched.cvss.score >= 9.0 %}text-p1
      {% elif enriched.cvss.score >= 7.0 %}text-p2
      {% else %}text-muted{% endif %}"
      style="font-size: 0.85rem">
      {{ "%.1f" | format(enriched.cvss.score) }}
    </span>
    {% else %}
    <span class="text-muted">—</span>
    {% endif %}
  </td>

  {# Description (truncated, full text on hover) #}
  <td style="max-width: 240px">
    {% if enriched and enriched.description %}
    <span title="{{ enriched.description }}"
          style="font-size: 0.78rem; color: #8b949e; display: block;
                 overflow: hidden; text-overflow: ellipsis; white-space: nowrap">
      {{ enriched.description }}
    </span>
    {% else %}
    <span class="text-muted">—</span>
    {% endif %}
  </td>

  {# KEV badge #}
  <td>
    {% if enriched and enriched.is_kev %}
    <span class="badge badge-p1" style="font-size: 0.7rem">KEV</span>
    {% else %}
    <span class="text-muted">—</span>
    {% endif %}
  </td>

  {# Status badge -- clickable, opens #statusModal #}
  <td>
    {% if vuln.status == 'closed' %}
    <span class="status-badge badge"
          data-cve="{{ vuln.cve_id }}"
          data-current-status="{{ vuln.status }}"
          data-bs-toggle="modal"
          data-bs-target="#statusModal"
          style="cursor: pointer; background-color: #21262d; color: #8b949e"
          title="Click to change status">
      Closed
    </span>
    {% else %}
    <span class="status-badge badge {{ _badge_cls.get(vuln.status, 'bg-secondary') }}"
          data-cve="{{ vuln.cve_id }}"
          data-current-status="{{ vuln.status }}"
          data-bs-toggle="modal"
          data-bs-target="#statusModal"
          style="cursor: pointer"
          title="Click to change status">
      {{ vuln.status | replace('_', ' ') | title }}
    </span>
    {% endif %}
  </td>

  {# Owner #}
  <td style="font-size: 0.78rem; color: #8b949e">
    {{ vuln.owner or "—" }}
  </td>

  {# SLA deadline countdown #}
  <td>
    <span class="{{ deadline_info.css }}" style="font-size: 0.82rem">
      {{ deadline_info.text }}
    </span>
  </td>

</tr>
