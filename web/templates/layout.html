<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}VulnAdvisor{% endblock %}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  <style>
    /* ── Base ────────────────────────────────────────────────── */
    body          { background-color: #0d1117; color: #c9d1d9; }
    .navbar       { background-color: #161b22 !important; border-bottom: 1px solid #30363d; }
    .card         { background-color: #161b22; border-color: #30363d; }
    .card-header  { background-color: #161b22; border-bottom-color: #30363d; }

    /* ── Table ───────────────────────────────────────────────── */
    .table        { --bs-table-bg: transparent; --bs-table-hover-bg: #1c2128; }
    .table thead th {
      border-color: #30363d;
      color: #8b949e;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .table tbody td  { border-color: #21262d; vertical-align: middle; }
    .table tbody tr:hover { background-color: #1c2128; }

    /* ── Priority colours ───────────────────────────────────── */
    .badge-p1     { background-color: #da3633 !important; }
    .badge-p2     { background-color: #d29922 !important; color: #000 !important; }
    .badge-p3     { background-color: #1f6feb !important; }
    .badge-p4     { background-color: #484f58 !important; }

    .text-p1      { color: #f85149 !important; font-weight: 600; }
    .text-p2      { color: #d29922 !important; font-weight: 600; }
    .text-p3      { color: #388bfd !important; }
    .text-p4      { color: #8b949e !important; }

    /* ── Criticality badges ─────────────────────────────────── */
    .badge-crit-critical { background-color: #da3633 !important; }
    .badge-crit-high     { background-color: #bd561d !important; }
    .badge-crit-medium   { background-color: #1f6feb !important; }
    .badge-crit-low      { background-color: #484f58 !important; }

    /* ── Exposure badges ────────────────────────────────────── */
    .badge-exp-internet  { background-color: #da3633 !important; }
    .badge-exp-internal  { background-color: #d29922 !important; color: #000 !important; }
    .badge-exp-isolated  { background-color: #238636 !important; }

    /* ── KPI card accents ───────────────────────────────────── */
    .kpi-card     { border-top-width: 3px !important; }
    .kpi-assets   { border-top-color: #238636 !important; }
    .kpi-p1       { border-top-color: #da3633 !important; }
    .kpi-open     { border-top-color: #1f6feb !important; }
    .kpi-overdue  { border-top-color: #da3633 !important; }
    .kpi-number   { font-size: 2.4rem; font-weight: 700; line-height: 1.1; }

    /* ── Status colours ─────────────────────────────────────── */
    .status-pending     { color: #8b949e; }
    .status-in_progress { color: #d29922; font-weight: 500; }
    .status-verified    { color: #388bfd; font-weight: 500; }
    .status-closed      { color: #3fb950; font-weight: 500; }
    .status-deferred    { color: #8b949e; text-decoration: line-through; }

    /* ── HTMX spinner ───────────────────────────────────────── */
    .htmx-indicator          { opacity: 0; transition: opacity 150ms ease-in; }
    .htmx-request .htmx-indicator { opacity: 1; }

    /* ── Misc ───────────────────────────────────────────────── */
    code  { color: #79c0ff; font-size: 0.85em; }
    .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    a { color: #58a6ff; }
    a:hover { color: #79c0ff; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg px-4">
  {% set current_user = try_get_current_user(request) %}
  <a class="navbar-brand fw-bold me-4" href="{% if current_user %}/{% else %}/cve{% endif %}" style="font-size: 1.1rem">
    <span style="color: #388bfd">Vuln</span><span style="color: #c9d1d9">Advisor</span>
  </a>
  <ul class="navbar-nav me-auto">
    <li class="nav-item">
      <a class="nav-link {% if request.url.path.startswith('/cve') %}active text-light{% else %}text-secondary{% endif %}"
         href="/cve"
         {% if request.url.path.startswith('/cve') %}aria-current="page"{% endif %}>CVE Search</a>
    </li>
    {% if current_user %}
    <li class="nav-item">
      <a class="nav-link {% if request.url.path == '/' %}active text-light{% else %}text-secondary{% endif %}"
         href="/"
         {% if request.url.path == '/' %}aria-current="page"{% endif %}>Dashboard</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.url.path.startswith('/assets') %}active text-light{% else %}text-secondary{% endif %}"
         href="/assets"
         {% if request.url.path.startswith('/assets') %}aria-current="page"{% endif %}>Assets</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.url.path == '/ingest' %}active text-light{% else %}text-secondary{% endif %}"
         href="/ingest"
         {% if request.url.path == '/ingest' %}aria-current="page"{% endif %}>Ingest</a>
    </li>
    {% endif %}
  </ul>
  <ul class="navbar-nav ms-auto align-items-center">
    <li class="nav-item">
      <a class="nav-link text-secondary" href="/docs" style="font-size: 0.85rem">API Docs</a>
    </li>
    {% if current_user %}
    <li class="nav-item dropdown ms-2">
      <a class="nav-link dropdown-toggle text-secondary" href="#" role="button"
         data-bs-toggle="dropdown" aria-expanded="false">
        {{ current_user.username }}
        {% if current_user.role == 'admin' %}
          <span class="badge bg-danger ms-1" style="font-size: 0.65rem">Admin</span>
        {% endif %}
      </a>
      <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
        <li><a class="dropdown-item" href="/settings">Settings</a></li>
        <li><a class="dropdown-item" href="/api-keys">API Keys</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="/logout">Logout</a></li>
      </ul>
    </li>
    {% else %}
    <li class="nav-item ms-2">
      <a class="nav-link" href="/login">Log In</a>
    </li>
    {% endif %}
  </ul>
</nav>

<main class="container-fluid px-4 py-4" style="max-width: 1400px">
  {% if flash_message %}
  <div class="alert alert-warning alert-dismissible fade show mx-0 mt-0 mb-3" role="alert">
    {{ flash_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}
  {% block content %}{% endblock %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% set current_user = try_get_current_user(request) %}
{% if current_user %}
  {% include "partials/session_modal.html" %}
  <script>
  /*
   * Session expiry detection -- schedules the re-auth modal based on the
   * non-httpOnly session_expires_at cookie set by set_auth_cookie().
   *
   * Why a cookie and not a JS variable? The server sets the cookie on every
   * login, so the expiry is always accurate even after a page refresh. A JS
   * variable would reset to the page-load time on every navigation.
   *
   * Security: session_expires_at contains only a Unix timestamp. No user data,
   * no token material. Exposing it to JS is safe -- it lets the modal fire at
   * the right time without any server round-trips.
   *
   * CSRF token handling: we try to read the fastapi-csrf-token cookie and
   * pre-populate the hidden CSRF field. If the CSRF cookie is also expired
   * (long idle session), the POST /login handler will raise CsrfProtectError,
   * which our error handler redirects to /login with a flash message. That is
   * the correct fallback -- not a silent failure.
   */
  (function () {
    var match = document.cookie.match(/session_expires_at=(\d+)/);
    if (!match) { return; }  // Not logged in or cookie already cleared

    var expiresAt = parseInt(match[1], 10);
    var now = Math.floor(Date.now() / 1000);
    var remaining = expiresAt - now;

    function showSessionModal() {
      var modalEl = document.getElementById('sessionExpiredModal');
      if (!modalEl) { return; }

      // Set the form action to POST /login with the current path as ?next=
      // so the user returns to exactly where they were after re-authenticating.
      var form = document.getElementById('sessionReauthForm');
      var nextPath = encodeURIComponent(window.location.pathname + window.location.search);
      form.action = '/login?next=' + nextPath;

      // Update OAuth button hrefs too (same ?next= for consistent return URL)
      var oauthButtons = modalEl.querySelectorAll('a[id^="sessionOauth"]');
      for (var i = 0; i < oauthButtons.length; i++) {
        var base = oauthButtons[i].getAttribute('href').split('?')[0];
        oauthButtons[i].setAttribute('href', base + '?next=' + nextPath);
      }

      // Try to pre-populate the CSRF token from the cookie.
      // If the CSRF cookie is expired, leave the field empty -- the POST
      // handler will redirect to /login with a flash message (correct fallback).
      var csrfMatch = document.cookie.match(/fastapi-csrf-token=([^;]+)/);
      if (csrfMatch) {
        document.getElementById('sessionCsrfToken').value = decodeURIComponent(csrfMatch[1]);
      }

      var modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Focus the password field when the modal finishes opening
      modalEl.addEventListener('shown.bs.modal', function () {
        document.getElementById('sessionPassword').focus();
      }, { once: true });
    }

    if (remaining <= 0) {
      // Session already expired when this page loaded (e.g. user left a tab open)
      showSessionModal();
    } else {
      // Schedule the modal to appear at the exact moment the session expires
      setTimeout(showSessionModal, remaining * 1000);
    }
  })();
  </script>
{% endif %}
</body>
</html>
