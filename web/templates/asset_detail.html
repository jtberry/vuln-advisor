{% extends "layout.html" %}
{% block title %}{{ asset.hostname }} — VulnAdvisor{% endblock %}

{% block content %}

{# ── Back + header ───────────────────────────────────────────────── #}
<div class="mb-3">
  <a href="/" class="text-muted text-decoration-none" style="font-size: 0.82rem">
    &larr; Dashboard
  </a>
</div>

{# ── Asset header card ───────────────────────────────────────────── #}
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">

      <div>
        <h5 class="fw-bold font-mono mb-2" style="color: #e6edf3">{{ asset.hostname }}</h5>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <span class="badge badge-crit-{{ asset.criticality }}">{{ asset.criticality.upper() }}</span>
          <span class="badge badge-exp-{{ asset.exposure }}">{{ asset.exposure.upper() }}</span>
          <span class="badge" style="background-color: #21262d; color: #8b949e">
            {{ asset.environment.upper() }}
          </span>
          {% if asset.ip %}
          <span class="badge font-mono" style="background-color: #21262d; color: #8b949e">
            {{ asset.ip }}
          </span>
          {% endif %}
          {% for tag in asset.tags %}
          <span class="badge" style="background-color: #21262d; color: #8b949e">{{ tag }}</span>
          {% endfor %}
          {% for framework in asset.compliance %}
          <span class="badge" style="background-color: #1c2d3e; color: #58a6ff; border: 1px solid #1f6feb">
            {{ framework }}
          </span>
          {% endfor %}
        </div>
      </div>

      <div class="d-flex flex-column align-items-end gap-2">
        <a href="/assets/{{ asset.id }}/edit"
           class="btn btn-sm"
           style="font-size: 0.78rem; background-color: #21262d; border-color: #30363d; color: #8b949e">
          Edit
        </a>
        <div class="text-muted" style="font-size: 0.8rem; text-align: right">
          {% if asset.owner %}
          <div>Owner: <span style="color: #c9d1d9">{{ asset.owner }}</span></div>
          {% endif %}
          <div>Registered: {{ asset.created_at[:10] }}</div>
          {% if asset.os %}
          <div>OS: <span style="color: #c9d1d9">{{ asset.os }}</span></div>
          {% endif %}
          <div>
            EOL:
            {% if eol_info.badge %}
            <span class="badge {{ eol_info.css }}" style="font-size: 0.72rem">{{ eol_info.text }}</span>
            {% else %}
            <span class="{{ eol_info.css }}">{{ eol_info.text }}</span>
            {% endif %}
          </div>
        </div>
      </div>

    </div>

    {# ── Mini priority summary ───────────────────────────────── #}
    <div class="d-flex gap-4 mt-3 pt-3" style="border-top: 1px solid #21262d">
      {% for label, count, css in [
          ('P1 — Critical', counts.P1, 'text-p1'),
          ('P2 — High',     counts.P2, 'text-p2'),
          ('P3 — Medium',   counts.P3, 'text-p3'),
          ('P4 — Low',      counts.P4, 'text-p4'),
      ] %}
      <div>
        <div class="fw-bold {% if count > 0 %}{{ css }}{% else %}text-muted{% endif %}">
          {{ count }}
        </div>
        <div class="text-muted" style="font-size: 0.7rem">{{ label }}</div>
      </div>
      {% endfor %}
    </div>

  </div>
</div>

{# ── Add CVEs form ───────────────────────────────────────────────── #}
<div class="card mb-4">
  <div class="card-header py-2 px-3">
    <span class="fw-semibold" style="color: #e6edf3; font-size: 0.9rem">Add CVEs</span>
  </div>
  <div class="card-body p-3">
    <form hx-post="/assets/{{ asset_id }}/vulnerabilities"
          hx-target="#vuln-table-body"
          hx-swap="innerHTML"
          hx-indicator="#add-cve-spinner">
      <div class="row g-3 align-items-end">

        <div class="col-lg-5">
          <label for="cve_ids_raw" class="form-label text-muted mb-1" style="font-size: 0.78rem">
            CVE IDs <span class="text-muted" style="font-size: 0.72rem">(one per line)</span>
          </label>
          <textarea id="cve_ids_raw" name="cve_ids_raw" rows="3"
                    class="form-control form-control-sm font-mono"
                    style="background-color: #21262d; border-color: #30363d; color: #c9d1d9; font-size: 0.8rem; resize: vertical"
                    placeholder="CVE-2021-44228&#10;CVE-2022-22965"></textarea>
        </div>

        <div class="col-lg-3">
          <label for="add-scanner" class="form-label text-muted mb-1" style="font-size: 0.78rem">Scanner</label>
          <select id="add-scanner" name="scanner"
                  class="form-select form-select-sm"
                  style="background-color: #21262d; border-color: #30363d; color: #c9d1d9; font-size: 0.8rem">
            <option value="manual" selected>Manual</option>
            <option value="trivy">Trivy</option>
            <option value="grype">Grype</option>
            <option value="nessus">Nessus</option>
            <option value="csv">CSV</option>
          </select>
        </div>

        <div class="col-lg-3">
          <label for="add-owner" class="form-label text-muted mb-1" style="font-size: 0.78rem">
            Owner <span class="text-muted" style="font-size: 0.72rem">(optional)</span>
          </label>
          <input type="text" id="add-owner" name="owner"
                 class="form-control form-control-sm"
                 style="background-color: #21262d; border-color: #30363d; color: #c9d1d9; font-size: 0.8rem"
                 placeholder="alice@example.com">
        </div>

        <div class="col-lg-1">
          <button type="submit"
                  class="btn btn-primary btn-sm w-100"
                  style="font-size: 0.78rem">
            <span>Add</span>
            <span id="add-cve-spinner"
                  class="htmx-indicator spinner-border spinner-border-sm ms-1"
                  style="width: 0.7rem; height: 0.7rem" role="status"></span>
          </button>
        </div>

      </div>
    </form>
  </div>
</div>

{# ── Vulnerability table ─────────────────────────────────────────── #}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center py-2 px-3">
    <span class="fw-semibold" style="color: #e6edf3; font-size: 0.9rem">Vulnerabilities</span>
    <span class="text-muted" style="font-size: 0.75rem">{{ vuln_rows | length }} linked</span>
  </div>

  <div class="card-body p-0">
    {% if vuln_rows %}

    {# ── Bulk action toolbar (hidden until checkboxes selected) ── #}
    <div id="bulkToolbar" class="d-none px-3 py-2 d-flex align-items-center gap-2"
         style="border-bottom: 1px solid #21262d">
      <span class="text-muted" style="font-size: 0.82rem">
        <span id="selectedCount">0</span> selected
      </span>
      <button id="bulkChangeBtn"
              class="btn btn-sm btn-outline-primary"
              style="font-size: 0.78rem">
        Change Status
      </button>
    </div>

    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th style="width: 32px; padding-left: 0.75rem" class="text-center">
            <input type="checkbox" class="form-check-input" id="selectAllVulns" title="Select all">
          </th>
          <th style="padding-left: 0.5rem; min-width: 160px">CVE</th>
          <th>Priority</th>
          <th>CVSS</th>
          <th style="min-width: 220px">Description</th>
          <th>KEV</th>
          <th>Status</th>
          <th>Owner</th>
          <th>SLA Deadline</th>
        </tr>
      </thead>
      <tbody id="vuln-table-body">
        {% for row in vuln_rows %}
        {% set vuln          = row.vuln %}
        {% set enriched      = row.enriched %}
        {% set deadline_info = row.deadline_info %}
        {% set nvd_url       = row.nvd_url %}
        {% include "partials/vuln_row.html" %}
        {% endfor %}
      </tbody>
    </table>

    {% else %}
    <div class="text-center py-5">
      <div class="text-muted mb-2">No vulnerabilities linked to this asset.</div>
      <div style="font-size: 0.82rem; color: #484f58">
        Use the <strong>Add CVEs</strong> form above to assign CVE IDs.
      </div>
    </div>
    {% endif %}

  </div>
</div>

{# ── Status modal (single + bulk) ────────────────────────────────── #}
{% include "partials/status_modal.html" %}

{# ── Toast container ─────────────────────────────────────────────── #}
<div id="toastContainer"
     class="toast-container position-fixed bottom-0 end-0 p-3"
     style="z-index: 9999">
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
  "use strict";

  var selectAll    = document.getElementById("selectAllVulns");
  var bulkToolbar  = document.getElementById("bulkToolbar");
  var selectedCount = document.getElementById("selectedCount");
  var bulkChangeBtn = document.getElementById("bulkChangeBtn");
  var statusModal  = document.getElementById("statusModal");

  if (!selectAll) return; // No vulns on page -- nothing to do

  // ── Collect all .vuln-checkbox elements ──────────────────────────
  function getCheckboxes() {
    return Array.prototype.slice.call(document.querySelectorAll(".vuln-checkbox"));
  }

  // ── Update bulk toolbar visibility and count ──────────────────────
  function updateBulkToolbar() {
    var checked = getCheckboxes().filter(function (cb) { return cb.checked; });
    var count   = checked.length;

    selectedCount.textContent = count;

    if (count > 0) {
      bulkToolbar.classList.remove("d-none");
    } else {
      bulkToolbar.classList.add("d-none");
    }

    // Keep select-all checkbox in sync
    var all = getCheckboxes();
    selectAll.checked       = all.length > 0 && count === all.length;
    selectAll.indeterminate = count > 0 && count < all.length;
  }

  // ── Select-all toggle ────────────────────────────────────────────
  selectAll.addEventListener("change", function () {
    getCheckboxes().forEach(function (cb) {
      cb.checked = selectAll.checked;
    });
    updateBulkToolbar();
  });

  // ── Individual checkbox changes ──────────────────────────────────
  document.getElementById("vuln-table-body").addEventListener("change", function (e) {
    if (e.target.classList.contains("vuln-checkbox")) {
      updateBulkToolbar();
    }
  });

  // ── Bulk Change Status button ────────────────────────────────────
  if (bulkChangeBtn && statusModal) {
    bulkChangeBtn.addEventListener("click", function () {
      var checked = getCheckboxes().filter(function (cb) { return cb.checked; });
      var cveIds  = checked.map(function (cb) { return cb.dataset.cveId; });

      // Set modal to bulk mode before Bootstrap opens it
      statusModal.dataset.mode     = "bulk";
      statusModal.dataset.bulkCves = JSON.stringify(cveIds);

      bootstrap.Modal.getOrCreateInstance(statusModal).show();
    });
  }

  // ── Single-badge click: ensure mode is single ────────────────────
  // Bootstrap uses relatedTarget on the show.bs.modal event; the modal
  // partial handles the rest. We just need to clear bulk mode here in
  // case the user previously opened in bulk mode then clicked a badge.
  document.querySelectorAll(".status-badge").forEach(function (badge) {
    badge.addEventListener("click", function () {
      statusModal.dataset.mode = "single";
    });
  });

}());
</script>
{% endblock %}
